{% load static %}
{% load portal_tags %}
<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ SITE_NAME }} — Portal</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  {% if user.is_authenticated %}<link rel="stylesheet" href="{% static 'portal/css/react_shell_skin.css' %}"><link rel="stylesheet" href="{% static 'portal/css/theme_orange.css' %}">{% endif %}

<script>
  window.ERP_USERLABEL = "{{ user.get_full_name|default:user.username|escapejs }}";
  window.ERP_LOGOUT_URL = "{% url 'logout' %}";
</script>
{% load static %}
<link rel="stylesheet" href="{% static 'css/forms.css' %}">
<style>
#erp-toast-box{position:fixed;left:16px;bottom:16px;z-index:3000;max-width:380px}
.erp-toast{display:none;margin-top:8px;padding:12px 14px;border-radius:10px;box-shadow:0 6px 16px rgba(0,0,0,.2);color:#0f5132;background:#e6f4ea}
.erp-warn{color:#664d03;background:#fff3cd}
.erp-alert{color:#842029;background:#f8d7da}
.erp-toast.show{display:block;animation:erp_fadein .2s ease-out}
@keyframes erp_fadein{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
</style>

</head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">{{ SITE_NAME }}</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav" aria-controls="nav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="nav">
      <ul class="navbar-nav me-auto">
        {% if user.is_authenticated %}
          {% if user|has_module:"vendas" %}<li class="nav-item"><a class="nav-link" href="{% url 'sales' %}">Vendas</a></li>{% endif %}
          {% if user|has_module:"financeiro" %}<li class="nav-item"><a class="nav-link" href="{% url 'finance' %}">Financeiro</a></li>{% endif %}
          {% if user|has_module:"fiscal" %}<li class="nav-item"><a class="nav-link" href="{% url 'fiscal' %}">Fiscal</a></li>{% endif %}
          {% if user|has_module:"estoque" %}<li class="nav-item"><a class="nav-link" href="{% url 'inventory' %}">Estoque</a></li>{% endif %}
          {% if user|has_module:"funcionario" %}<li class="nav-item"><a class="nav-link" href="{% url 'staff' %}">Funcionário</a></li>{% endif %}
          {% if user|has_module:"configuracao" %}<li class="nav-item"><a class="nav-link" href="{% url 'config' %}">Configuração</a></li>{% endif %}
        {% endif %}
      </ul>
      <ul class="navbar-nav ms-2">
  {% if user.is_authenticated %}
  <li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
      <i class="bi bi-person-circle me-2"></i>
      <span class="fw-semibold">{{ user.username }}</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end">
      <li class="dropdown-header">
        <div class="fw-semibold">{{ user.username }}</div>
        {% if user.email %}<small class="text-muted">{{ user.email }}</small>{% endif %}
      </li>
      <li><hr class="dropdown-divider"></li>
      <!-- Tema alternado via JS -->
      <li><button type="button" class="dropdown-item" id="rs-theme-dd">Tema</button></li>
      <!-- Alterar Senha (removido por não haver rota configurada) -->
      <li>
        <form method="post" action="{% url 'logout' %}" class="m-0 p-0">
          {% csrf_token %}
          <button class="dropdown-item" type="submit">Sair</button>
        </form>
      </li>
    </ul>
  </li>
  {% else %}
  <li class="nav-item"><a class="btn btn-outline-light btn-sm" href="{% url 'login' %}">Entrar</a></li>
  {% endif %}
</ul>
    </div>
  </div>
</nav>
<main class="container py-4">
  {% block content %}{% endblock %}
</main>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  {% if user.is_authenticated %}<script src="{% static 'portal/js/react_shell_skin.js' %}"></script>{% endif %}
{% load static %}
<script src="{% static 'js/form-required.js' %}"></script>
<script src="{% static 'js/money-br.js' %}"></script>
<div id="erp-toast-box" aria-live="polite" aria-atomic="true"></div>
<script>
(function(){
  if (!window.ERP_USERLABEL) return;
  const box = document.getElementById('erp-toast-box');
  const DURATION = 10000; // 10s absolute from server send time

  function renderToast(pkt, remainingMs){
    const el = document.createElement('div');
    el.className = 'erp-toast ' + (pkt.level==='alert'?'erp-alert':(pkt.level==='warn'?'erp-warn':''));
    el.innerHTML = '<strong>' + (pkt.level==='alert'?'Atenção':(pkt.level==='warn'?'Cuidado':'Informação')) + ':</strong> ' + (pkt.message||'').replace(/</g,'&lt;');
    box.appendChild(el);
    setTimeout(()=>{ el.classList.add('show'); }, 10);
    const ms = Math.max(0, remainingMs);
    setTimeout(()=>{
      el.remove();
      try { localStorage.setItem('erp_seen_broadcast_id', String(pkt.id)); } catch(e){}
      try { localStorage.removeItem('erp_active_toast'); } catch(e){}
    }, ms);
  }

  function restoreActiveToast(){
    try {
      const raw = localStorage.getItem('erp_active_toast');
      if (!raw) return false;
      const t = JSON.parse(raw);
      const remaining = (t.expires_at_ms || 0) - Date.now();
      if (remaining > 50) {
        renderToast(t, remaining);
        return true;
      } else {
        localStorage.removeItem('erp_active_toast');
        if (t.id) localStorage.setItem('erp_seen_broadcast_id', String(t.id));
      }
    } catch(e){}
    return false;
  }

  // Restore if an active toast exists (cross-page persistence)
  restoreActiveToast();

  // Build since_id using max of fully seen and ack
  let seenId = 0, ackId = 0;
  try { seenId = parseInt(localStorage.getItem('erp_seen_broadcast_id')||'0',10) || 0; } catch(e){}
  try { ackId  = parseInt(localStorage.getItem('erp_ack_broadcast_id') ||'0',10) || 0; } catch(e){}
  let sinceId = Math.max(seenId, ackId);

  async function poll(){
    try{
      const r = await fetch('/notifications/poll?since_id='+sinceId, {headers:{'X-Requested-With':'fetch'}});
      if(!r.ok) return;
      const data = await r.json();
      if(data && data.has && data.toast){
        const t = data.toast;
        const remaining = (typeof t.expires_in_ms === 'number') ? t.expires_in_ms : DURATION;
        if (remaining <= 0) {
          // already expired on server; mark seen/ack and skip
          try { localStorage.setItem('erp_seen_broadcast_id', String(t.id)); } catch(e){}
          try { localStorage.setItem('erp_ack_broadcast_id', String(t.id)); } catch(e){}
          sinceId = Math.max(sinceId, t.id);
          return;
        }
        // Avoid duplicating if an active toast with same id exists
        try {
          const raw = localStorage.getItem('erp_active_toast');
          if (raw){
            const cur = JSON.parse(raw);
            if (cur && cur.id === t.id) return;
          }
        } catch(e){}
        // ACK immediately to prevent re-fetch on reloads
        try { localStorage.setItem('erp_ack_broadcast_id', String(t.id)); } catch(e){}
        sinceId = Math.max(sinceId, t.id);
        // Persist an active toast with absolute expiry from server
        const expiresAtMs = Date.now() + remaining;
        const pkt = {id:t.id, message:t.message, level:t.level, expires_at_ms: expiresAtMs};
        try { localStorage.setItem('erp_active_toast', JSON.stringify(pkt)); } catch(e){}
        renderToast(pkt, remaining);
      }
    }catch(e){}
  }

  setInterval(poll, 3000);
  poll();
})();
</script>

</body>
</html>
